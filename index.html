<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMIGLIA - Mafia Empire on Solana</title>
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Cinzel:wght@400;600;800&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--blood-red:#8B0000;--gold:#D4AF37;--dark-gold:#9B7E2B;--cream:#F5E6D3;--black:#0A0A0A;--grey:#1A1A1A;--smoke:#2A2A2A;--wine:#4A0E23}
        body{font-family:'Crimson Text',serif;background:var(--black);color:var(--cream);overflow:hidden;
            cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="rgba(212,175,55,0.3)" stroke="%23D4AF37" stroke-width="1"/></svg>'),auto}
        body::before{content:'';position:fixed;inset:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.05"/></svg>');pointer-events:none;z-index:9999;mix-blend-mode:overlay}
        body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 0%,rgba(0,0,0,0.7) 100%);pointer-events:none;z-index:9998}

        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;backdrop-filter:blur(4px)}
        .overlay.active{display:block}
        .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);z-index:10001;opacity:0;transition:all .4s cubic-bezier(.16,1,.3,1)}
        .modal.active{display:block;transform:translate(-50%,-50%) scale(1);opacity:1}

        /* Wallet */
        .wallet-modal{min-width:420px;background:linear-gradient(145deg,rgba(26,26,26,.99),rgba(15,10,5,.99));border:2px solid var(--gold);border-radius:2px;box-shadow:0 0 80px rgba(212,175,55,.15)}
        .wallet-header{background:linear-gradient(135deg,var(--blood-red),var(--wine));padding:25px 35px;border-bottom:2px solid var(--gold)}
        .wallet-header h3{font-family:'Cinzel',serif;color:var(--gold);font-size:1.6rem;letter-spacing:3px}
        .wallet-header p{color:rgba(245,230,211,.6);font-size:.85rem;margin-top:5px;font-style:italic}
        .wallet-body{padding:25px 35px 30px}
        .wallet-options{display:flex;flex-direction:column;gap:10px}
        .wallet-btn{font-family:'Cinzel',serif;background:linear-gradient(135deg,rgba(42,42,42,.8),rgba(26,26,26,.9));color:var(--cream);border:1px solid rgba(212,175,55,.3);padding:14px 20px;font-size:1rem;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:15px;letter-spacing:1px;border-radius:2px}
        .wallet-btn:hover{background:linear-gradient(135deg,var(--gold),var(--dark-gold));color:var(--black);transform:translateX(5px);border-color:var(--gold)}
        .wallet-icon{font-size:1.4rem;width:30px;text-align:center}
        .wallet-status{color:var(--gold);font-size:.9rem;text-align:center;margin-top:15px;min-height:20px}

        /* Shop */
        .shop-modal{min-width:520px;max-width:560px;background:linear-gradient(160deg,rgba(16,12,8,.99),rgba(10,8,5,.99));border:2px solid var(--gold);border-radius:2px;box-shadow:0 0 100px rgba(212,175,55,.12),0 30px 60px rgba(0,0,0,.8)}
        .shop-header{position:relative;background:linear-gradient(135deg,#1a0a00,#0a0500);padding:28px 35px;border-bottom:2px solid var(--gold);overflow:hidden}
        .shop-header::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(212,175,55,.03) 10px,rgba(212,175,55,.03) 20px)}
        .shop-header h2{font-family:'Pirata One',cursive;color:var(--gold);font-size:2.2rem;text-align:center;text-shadow:0 0 30px rgba(212,175,55,.4);position:relative}
        .shop-header p{font-family:'Cormorant Garamond',serif;color:rgba(245,230,211,.5);text-align:center;margin-top:4px;font-style:italic;letter-spacing:3px;position:relative}
        .shop-body{padding:25px 30px 30px}

        .shop-item{background:linear-gradient(135deg,rgba(42,32,20,.5),rgba(26,20,14,.6));border:1px solid rgba(212,175,55,.25);border-radius:3px;padding:20px;margin-bottom:20px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
        .shop-item:hover{border-color:var(--gold);box-shadow:0 0 25px rgba(212,175,55,.15);transform:translateY(-2px)}
        .shop-item.selected{border-color:var(--gold);box-shadow:0 0 30px rgba(212,175,55,.25)}
        .shop-item.selected::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,175,55,.08),transparent);pointer-events:none}
        .shop-item-top{display:flex;align-items:center;gap:15px;margin-bottom:12px}
        .shop-item-icon{font-size:2.5rem;width:55px;height:55px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);border:1px solid rgba(212,175,55,.2);border-radius:3px}
        .shop-item-info h4{font-family:'Cinzel',serif;color:var(--gold);font-size:1.15rem;letter-spacing:1px}
        .shop-item-info p{font-family:'Cormorant Garamond',serif;color:rgba(245,230,211,.5);font-size:.9rem;font-style:italic;margin-top:2px}
        .shop-item-desc{font-family:'Cormorant Garamond',serif;color:var(--cream);line-height:1.7;font-size:1.05rem;border-left:3px solid var(--blood-red);padding-left:14px;margin-bottom:15px;opacity:.85}
        .shop-item-stats{display:flex;gap:20px}
        .shop-item-stat{display:flex;align-items:center;gap:6px;font-family:'Cinzel',serif;font-size:.85rem}
        .shop-item-stat .label{color:rgba(212,175,55,.6);letter-spacing:1px}
        .shop-item-stat .val{color:var(--gold);font-weight:700;font-size:1rem}

        .shop-footer{display:flex;gap:15px;margin-top:5px}
        .shop-balance{font-family:'Cinzel',serif;color:rgba(212,175,55,.7);font-size:.85rem;letter-spacing:1px;margin-bottom:15px;text-align:center}
        .shop-balance span{color:var(--gold);font-size:1.1rem;font-weight:700}

        .btn-gold{flex:1;font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--blood-red),#6B0000);color:var(--gold);border:2px solid var(--gold);padding:15px;font-size:1.05rem;cursor:pointer;font-weight:700;letter-spacing:3px;transition:all .3s;border-radius:2px}
        .btn-gold:hover{background:linear-gradient(135deg,var(--gold),var(--dark-gold));color:var(--black);box-shadow:0 0 30px rgba(212,175,55,.4);transform:translateY(-2px)}
        .btn-gold:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
        .btn-ghost{font-family:'Cinzel',serif;background:transparent;color:rgba(212,175,55,.5);border:1px solid rgba(212,175,55,.2);padding:15px 22px;font-size:.9rem;cursor:pointer;letter-spacing:2px;transition:all .3s;border-radius:2px}
        .btn-ghost:hover{border-color:var(--blood-red);color:var(--cream)}

        /* Top buttons */
        .top-buttons{position:fixed;top:20px;right:20px;display:flex;gap:12px;z-index:10000;pointer-events:auto}
        .top-btn{font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--gold),var(--dark-gold));color:var(--black);border:none;padding:12px 28px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .3s;letter-spacing:2px;border-radius:2px;box-shadow:0 4px 15px rgba(0,0,0,.4)}
        .top-btn:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(212,175,55,.4)}
        .wallet-connected{background:linear-gradient(135deg,var(--blood-red),#A00000);color:var(--gold)}

        /* Placement banner */
        .placement-banner{display:none;position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:10000;background:linear-gradient(135deg,rgba(139,0,0,.95),rgba(74,14,35,.95));border:2px solid var(--gold);padding:12px 35px;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem;letter-spacing:3px;pointer-events:none;border-radius:2px;animation:pulse 2s ease-in-out infinite}
        .placement-banner.active{display:block}
        @keyframes pulse{0%,100%{box-shadow:0 10px 40px rgba(0,0,0,.6),0 0 15px rgba(212,175,55,.2)}50%{box-shadow:0 10px 40px rgba(0,0,0,.6),0 0 30px rgba(212,175,55,.4)}}

        /* HUD */
        .hud{position:absolute;top:20px;left:20px;background:linear-gradient(160deg,rgba(26,26,26,.97),rgba(15,10,5,.97));padding:22px 25px;border:2px solid var(--gold);pointer-events:auto;border-radius:2px;box-shadow:0 10px 40px rgba(0,0,0,.5),inset 0 1px 0 rgba(212,175,55,.1);min-width:220px}
        .hud-title{font-family:'Pirata One',cursive;color:var(--gold);font-size:1.4rem;margin-bottom:12px;text-shadow:0 0 15px rgba(212,175,55,.3);letter-spacing:2px}
        .hud-row{color:var(--cream);font-size:1rem;margin:8px 0;display:flex;justify-content:space-between;font-family:'Cormorant Garamond',serif}
        .hud-row span:last-child{color:var(--gold);font-weight:600;font-family:'Cinzel',serif;font-size:.95rem}
        .hud-div{height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:10px 0;opacity:.3}
        .hud-btn{width:100%;font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--blood-red),#6B0000);color:var(--gold);border:1px solid var(--gold);padding:10px;font-size:.85rem;cursor:pointer;letter-spacing:2px;margin-top:8px;transition:all .3s;border-radius:2px;pointer-events:auto}
        .hud-btn:hover{background:linear-gradient(135deg,#D4AF37,#9B7E2B);color:#0A0A0A}

        /* Minimap */
        .minimap-wrap{position:absolute;bottom:20px;right:20px;width:200px;height:200px;background:rgba(26,26,26,.97);border:2px solid var(--gold);pointer-events:auto;border-radius:2px;box-shadow:0 10px 40px rgba(0,0,0,.5);overflow:hidden}
        .minimap-label{position:absolute;top:5px;left:50%;transform:translateX(-50%);color:var(--gold);font-size:.75rem;font-family:'Cinzel',serif;letter-spacing:2px;z-index:2}
        .ctrl{position:absolute;bottom:228px;right:20px;background:linear-gradient(160deg,rgba(26,26,26,.95),rgba(15,10,5,.95));padding:12px 16px;border:1px solid rgba(212,175,55,.4);color:var(--cream);font-size:.8rem;max-width:200px;border-radius:2px}
        .ctrl-t{color:var(--gold);font-family:'Cinzel',serif;margin-bottom:6px;font-size:.8rem;letter-spacing:2px}
        .ctrl div{margin:3px 0;opacity:.8;font-family:'Cormorant Garamond',serif;font-size:.95rem}

        /* Toast */
        .toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%) translateY(100px);z-index:10002;background:linear-gradient(135deg,rgba(139,0,0,.95),rgba(74,14,35,.95));border:2px solid var(--gold);padding:15px 40px;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem;letter-spacing:2px;transition:transform .5s cubic-bezier(.16,1,.3,1);border-radius:2px;box-shadow:0 10px 40px rgba(0,0,0,.6);pointer-events:none}
        .toast.show{transform:translateX(-50%) translateY(0)}
    </style>
</head>
<body>
    <div class="top-buttons">
        <button class="top-btn" id="walletBtn" onclick="openWallet()">CONNECT WALLET</button>
        <button class="top-btn" onclick="window.open('docs.html','_blank')">DOCS</button>
    </div>
    <div class="placement-banner" id="placeBanner">LEFT CLICK TO PLACE ¬∑ RIGHT CLICK TO CANCEL</div>
    <div class="toast" id="toast"></div>

    <!-- WALLET MODAL -->
    <div class="overlay" id="walletOv" onclick="closeWallet()"></div>
    <div class="modal wallet-modal" id="walletMod">
        <div class="wallet-header"><h3>JOIN THE FAMILY</h3><p>Entra nella famiglia</p></div>
        <div class="wallet-body">
            <div class="wallet-options">
                <button class="wallet-btn" onclick="connectWallet('phantom')"><span class="wallet-icon">üëª</span>Phantom</button>
                <button class="wallet-btn" onclick="connectWallet('solflare')"><span class="wallet-icon">üî•</span>Solflare</button>
                <button class="wallet-btn" onclick="connectWallet('backpack')"><span class="wallet-icon">üéí</span>Backpack</button>
                <button class="wallet-btn" onclick="connectWallet('glow')"><span class="wallet-icon">‚ú®</span>Glow</button>
                <button class="wallet-btn" onclick="connectWallet('trust')"><span class="wallet-icon">üõ°Ô∏è</span>Trust Wallet</button>
                <button class="wallet-btn" onclick="connectWallet('coinbase')"><span class="wallet-icon">üî∑</span>Coinbase Wallet</button>
            </div>
            <div class="wallet-status" id="walletStatus"></div>
            <button class="btn-ghost" onclick="closeWallet()" style="width:100%;margin-top:15px">CLOSE</button>
        </div>
    </div>

    <!-- SHOP MODAL -->
    <div class="overlay" id="shopOv" onclick="closeShop()"></div>
    <div class="modal shop-modal" id="shopMod">
        <div class="shop-header">
            <h2>The Black Market</h2>
            <p>‚Äî Il Mercato Nero ‚Äî</p>
        </div>
        <div class="shop-body">
            <div class="shop-balance">YOUR BALANCE: <span id="shopBal">$50,000</span></div>

            <div class="shop-item selected" id="shopItem1" onclick="selectItem(0)">
                <div class="shop-item-top">
                    <div class="shop-item-icon">üé∞</div>
                    <div class="shop-item-info">
                        <h4>The Golden Crown Casino</h4>
                        <p>La Corona d'Oro</p>
                    </div>
                </div>
                <div class="shop-item-desc">A high-stakes casino where fortunes are won and lost. Poker tables, slot machines, and VIP lounges ‚Äî the crown jewel of your empire.</div>
                <div class="shop-item-stats">
                    <div class="shop-item-stat"><span class="label">PRICE</span><span class="val">$25K</span></div>
                    <div class="shop-item-stat"><span class="label">INCOME</span><span class="val">$500/h</span></div>
                    <div class="shop-item-stat"><span class="label">RISK</span><span class="val" style="color:#ff6347">HIGH</span></div>
                </div>
            </div>

            <div class="shop-item" id="shopItem2" style="opacity:.4;pointer-events:none;position:relative">
                <div style="position:absolute;top:10px;right:12px;font-family:'Cinzel',serif;color:var(--blood-red);font-size:.75rem;letter-spacing:2px;border:1px solid var(--blood-red);padding:3px 10px;border-radius:2px">COMING SOON</div>
                <div class="shop-item-top">
                    <div class="shop-item-icon">üç∏</div>
                    <div class="shop-item-info">
                        <h4>The Dark Shadow Lounge</h4>
                        <p>Ombra Nera</p>
                    </div>
                </div>
                <div class="shop-item-stats">
                    <div class="shop-item-stat"><span class="label">PRICE</span><span class="val">$15K</span></div>
                    <div class="shop-item-stat"><span class="label">INCOME</span><span class="val">$300/h</span></div>
                </div>
            </div>

            <div class="shop-item" id="shopItem3" style="opacity:.4;pointer-events:none;position:relative">
                <div style="position:absolute;top:10px;right:12px;font-family:'Cinzel',serif;color:var(--blood-red);font-size:.75rem;letter-spacing:2px;border:1px solid var(--blood-red);padding:3px 10px;border-radius:2px">COMING SOON</div>
                <div class="shop-item-top">
                    <div class="shop-item-icon">üè®</div>
                    <div class="shop-item-info">
                        <h4>The Palace Hotel</h4>
                        <p>Il Palazzo</p>
                    </div>
                </div>
                <div class="shop-item-stats">
                    <div class="shop-item-stat"><span class="label">PRICE</span><span class="val">$50K</span></div>
                    <div class="shop-item-stat"><span class="label">INCOME</span><span class="val">$1,000/h</span></div>
                </div>
            </div>

            <div class="shop-footer">
                <button class="btn-gold" id="buyBtn" onclick="enterPlacement()">PLACE CASINO</button>
                <button class="btn-ghost" onclick="closeShop()">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- GAME -->
    <div id="gc" style="position:fixed;inset:0;z-index:1">
        <canvas id="cv"></canvas>
        <div style="position:absolute;inset:0;pointer-events:none">
            <div class="hud">
                <div class="hud-title">The Family <span style="font-family:'Cormorant Garamond',serif;font-size:.8rem;opacity:.5;font-style:italic;display:block;margin-top:2px">La Famiglia</span></div>
                <div class="hud-row"><span>üí∞ Money</span><span>$<span id="hMoney">50,000</span></span></div>
                <div class="hud-div"></div>
                <div class="hud-row"><span>üé∞ Casinos</span><span id="hCount">0</span></div>
                <div class="hud-row"><span>üíµ Income/h</span><span>$<span id="hIncome">0</span></span></div>
                <div class="hud-div"></div>
                <button class="hud-btn" onclick="openShop()">THE BLACK MARKET</button>
            </div>
            <div class="minimap-wrap"><canvas id="mm" width="200" height="200" style="display:block"></canvas><div class="minimap-label">MAP</div></div>
            <div class="ctrl"><div class="ctrl-t">CONTROLS</div><div>üñ±Ô∏è Left Click ‚Äî Move</div><div>üè¢ Shop ‚Äî Buy & Place</div><div>üîç Scroll ‚Äî Zoom</div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
    let scene,camera,renderer,player,loader,gameActive=true;
    let money=50000,casinos=[],target=null,moving=false,placing=false;
    let camDist=40,camMin=12,camMax=65;
    let placeGlow=null,placeInner=null,placeArrows=[];
    let wp=null,wpArr=[];
    const PRICE=25000,INCOME=500;
    const GLB_BASE='https://raw.githubusercontent.com/Strawrfsa/famiglia-assets/main/';

    function toast(m,d=2500){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d)}
    function openWallet(){document.getElementById('walletMod').classList.add('active');document.getElementById('walletOv').classList.add('active')}
    function closeWallet(){document.getElementById('walletMod').classList.remove('active');document.getElementById('walletOv').classList.remove('active')}

    async function connectWallet(type){
        const st=document.getElementById('walletStatus'),btn=document.getElementById('walletBtn');
        st.textContent=`Connecting to ${type}...`;
        try{
            let p=null;
            if(type==='phantom'&&window.phantom?.solana)p=window.phantom.solana;
            else if(type==='solflare'&&window.solflare)p=window.solflare;
            else if(type==='backpack'&&window.backpack)p=window.backpack;
            else if(type==='glow'&&window.glowSolana)p=window.glowSolana;
            else if(type==='trust'&&window.trustwallet?.solana)p=window.trustwallet.solana;
            else if(type==='coinbase'&&window.coinbaseSolana)p=window.coinbaseSolana;
            if(p){const r=await p.connect(),a=r.publicKey.toString();
                st.textContent=`Connected: ${a.slice(0,6)}...${a.slice(-4)}`;
                btn.textContent=`${a.slice(0,4)}...${a.slice(-4)}`;btn.classList.add('wallet-connected');
                toast('BENVENUTO NELLA FAMIGLIA');setTimeout(closeWallet,1200);
            }else{
                const u={phantom:'https://phantom.app/',solflare:'https://solflare.com/',backpack:'https://backpack.app/',glow:'https://glow.app/',trust:'https://trustwallet.com/',coinbase:'https://www.coinbase.com/wallet'};
                st.textContent=`${type} not detected. Opening install page...`;setTimeout(()=>window.open(u[type],'_blank'),1500);
            }
        }catch(e){st.textContent='Connection rejected.';console.error(e)}
    }

    function selectItem(i){/* only item 0 for now */}
    function openShop(){
        document.getElementById('shopBal').textContent='$'+money.toLocaleString();
        document.getElementById('buyBtn').disabled=money<PRICE;
        document.getElementById('shopMod').classList.add('active');document.getElementById('shopOv').classList.add('active');
    }
    function closeShop(){document.getElementById('shopMod').classList.remove('active');document.getElementById('shopOv').classList.remove('active')}

    function enterPlacement(){
        if(money<PRICE){toast('NOT ENOUGH MONEY!');return}
        closeShop();placing=true;
        document.getElementById('placeBanner').classList.add('active');
        if(!placeGlow){
            placeGlow=new THREE.Mesh(new THREE.RingGeometry(1.8,3.2,32),new THREE.MeshBasicMaterial({color:0xD4AF37,side:THREE.DoubleSide,transparent:true,opacity:.5}));
            placeGlow.rotation.x=-Math.PI/2;placeGlow.position.y=.1;scene.add(placeGlow);
            placeInner=new THREE.Mesh(new THREE.CircleGeometry(2,32),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:.12,side:THREE.DoubleSide}));
            placeInner.rotation.x=-Math.PI/2;placeInner.position.y=.08;scene.add(placeInner);
            const off=[[0,-3.8],[0,3.8],[-3.8,0],[3.8,0]],rot=[0,Math.PI,Math.PI/2,-Math.PI/2];
            for(let i=0;i<4;i++){const s=new THREE.Shape();s.moveTo(0,.6);s.lineTo(-.3,0);s.lineTo(.3,0);s.closePath();
                const a=new THREE.Mesh(new THREE.ShapeGeometry(s),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:.8,side:THREE.DoubleSide}));
                a.rotation.x=-Math.PI/2;a.position.y=.12;a.userData={ox:off[i][0],oz:off[i][1],rz:rot[i]};
                placeArrows.push(a);scene.add(a)}
        }
        placeGlow.visible=placeInner.visible=true;placeArrows.forEach(a=>a.visible=true);
    }
    function exitPlacement(){placing=false;document.getElementById('placeBanner').classList.remove('active');
        if(placeGlow){placeGlow.visible=placeInner.visible=false}placeArrows.forEach(a=>a.visible=false)}

    function placeCasino(pos){
        if(money<PRICE){toast('NOT ENOUGH MONEY!');return}
        money-=PRICE;exitPlacement();
        loader.load(GLB_BASE+'harlem_casino.glb',g=>{
            const m=g.scene.clone();m.position.set(pos.x,0,pos.z);m.scale.set(.5,.5,.5);m.rotation.y=Math.PI;
            m.traverse(c=>{if(c.isMesh){c.castShadow=true;c.receiveShadow=true}});
            scene.add(m);casinos.push({model:m,pos});updateUI();toast("LA CORONA D'ORO ‚Äî ESTABLISHED");
        },undefined,()=>{
            const g=new THREE.Group();
            const b=new THREE.Mesh(new THREE.BoxGeometry(3,4,3),new THREE.MeshStandardMaterial({color:0x8B0000,emissive:0xff0000,emissiveIntensity:.2}));
            b.position.y=2;b.castShadow=true;g.add(b);
            const s=new THREE.Mesh(new THREE.BoxGeometry(2.5,.6,.15),new THREE.MeshStandardMaterial({color:0xD4AF37,emissive:0xD4AF37,emissiveIntensity:1.5}));
            s.position.set(0,4.3,1.6);g.add(s);
            g.position.set(pos.x,0,pos.z);scene.add(g);casinos.push({model:g,pos});updateUI();toast("LA CORONA D'ORO ‚Äî ESTABLISHED");
        });
    }
    function updateUI(){
        document.getElementById('hMoney').textContent=money.toLocaleString();
        document.getElementById('hCount').textContent=casinos.length;
        document.getElementById('hIncome').textContent=(casinos.length*INCOME).toLocaleString();
    }

    function makeWP(pt){removeWP();
        wp=new THREE.Mesh(new THREE.CircleGeometry(.4,16),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:.7,side:THREE.DoubleSide}));
        wp.rotation.x=-Math.PI/2;wp.position.set(pt.x,.1,pt.z);scene.add(wp);
        for(let i=0;i<4;i++){const s=new THREE.Shape();s.moveTo(0,.4);s.lineTo(-.2,0);s.lineTo(.2,0);s.closePath();
            const a=new THREE.Mesh(new THREE.ShapeGeometry(s),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:.6,side:THREE.DoubleSide}));
            a.rotation.x=-Math.PI/2;const an=i*Math.PI/2,d=1.2;
            a.position.set(pt.x+Math.sin(an)*d,.12,pt.z+Math.cos(an)*d);a.rotation.z=-an;
            wpArr.push(a);scene.add(a)}}
    function removeWP(){if(wp){scene.remove(wp);wp=null}wpArr.forEach(a=>scene.remove(a));wpArr=[]}

    window.addEventListener('load',()=>{
        const cv=document.getElementById('cv');
        scene=new THREE.Scene();scene.background=new THREE.Color(0x080808);scene.fog=new THREE.FogExp2(0x080808,.005);
        camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,800);
        camera.position.set(0,camDist,22);camera.lookAt(0,0,0);
        renderer=new THREE.WebGLRenderer({canvas:cv,antialias:true});
        renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
        renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
        renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.4;
        loader=new THREE.GLTFLoader();

        // === SKY DOME ===
        const skyGeo=new THREE.SphereGeometry(300,32,16);
        const skyMat=new THREE.ShaderMaterial({
            uniforms:{uTime:{value:0},uSunPos:{value:new THREE.Vector3(0,.3,1)}},
            vertexShader:`varying vec3 vPos;void main(){vPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
            fragmentShader:`
                uniform float uTime;uniform vec3 uSunPos;varying vec3 vPos;
                void main(){
                    vec3 dir=normalize(vPos);float h=dir.y*.5+.5;
                    float sunY=sin(uTime*.05);
                    vec3 dayTop=vec3(.15,.25,.55);vec3 dayBot=vec3(.6,.5,.35);
                    vec3 sunsetTop=vec3(.15,.08,.2);vec3 sunsetBot=vec3(.7,.25,.1);
                    vec3 nightTop=vec3(.05,.05,.12);vec3 nightBot=vec3(.08,.07,.12);
                    float dayF=smoothstep(-.2,.3,sunY);float sunsetF=smoothstep(-.3,0.,sunY)*smoothstep(.3,0.,sunY);
                    vec3 top=mix(nightTop,dayTop,dayF)+sunsetTop*sunsetF;
                    vec3 bot=mix(nightBot,dayBot,dayF)+sunsetBot*sunsetF;
                    vec3 col=mix(bot,top,h);
                    // Sun glow
                    vec3 sunDir=normalize(vec3(cos(uTime*.05)*.8,sunY,sin(uTime*.05)*.8));
                    float sunDot=max(dot(dir,sunDir),0.);
                    col+=vec3(1.,.7,.3)*pow(sunDot,64.)*.8;
                    col+=vec3(1.,.5,.2)*pow(sunDot,8.)*.3;
                    // Stars at night
                    float nightF=1.-dayF;
                    float star=step(.998,fract(sin(dot(floor(dir*300.),vec3(12.9898,78.233,45.164)))*43758.5453));
                    col+=vec3(1.)*star*nightF*.6;
                    gl_FragColor=vec4(col,1.);
                }`,
            side:THREE.BackSide
        });
        const sky=new THREE.Mesh(skyGeo,skyMat);scene.add(sky);

        // === OUTER LANDSCAPE (beyond playable area) ===
        const outerGround=new THREE.Mesh(new THREE.PlaneGeometry(600,600),new THREE.MeshStandardMaterial({color:0x1a1a12,roughness:1,metalness:0}));
        outerGround.rotation.x=-Math.PI/2;outerGround.position.y=-.05;outerGround.name='g';scene.add(outerGround);
        // === TRAFFIC CARS (drive along CENTER HORIZONTAL street only, z=0) ===
        const trafficCars=[];
        const trafficMat=[
            new THREE.MeshStandardMaterial({color:0x8B0000,metalness:.85,roughness:.15}),
            new THREE.MeshStandardMaterial({color:0x050505,metalness:.9,roughness:.1}),
            new THREE.MeshStandardMaterial({color:0x2F4F4F,metalness:.85,roughness:.15}),
            new THREE.MeshStandardMaterial({color:0x888888,metalness:.9,roughness:.1})
        ];
        const hlMat=new THREE.MeshStandardMaterial({color:0xffffcc,emissive:0xffffcc,emissiveIntensity:.6});
        const tlMat=new THREE.MeshStandardMaterial({color:0xff0000,emissive:0xff0000,emissiveIntensity:.4});
        function spawnTrafficCar(){
            const c=new THREE.Group();const cm=trafficMat[~~(Math.random()*trafficMat.length)];
            c.add(M(new THREE.BoxGeometry(1.8,.7,4.2),cm,0,.4,0,true));
            c.add(M(new THREE.BoxGeometry(1.5,.55,1.8),cm,0,1,-.3));
            [[-0.65,.4,2.15],[.65,.4,2.15]].forEach(([hx,hy,hz])=>{c.add(M(new THREE.SphereGeometry(.1,6,6),hlMat,hx,hy,hz))});
            [[-0.65,.4,-2.15],[.65,.4,-2.15]].forEach(([tx,ty,tz])=>{c.add(M(new THREE.SphereGeometry(.08,6,6),tlMat,tx,ty,tz))});
            // Always horizontal center street (z=0), random lane
            const lane=Math.random()>.5?1.3:-1.3;
            const dir=Math.random()>.5?1:-1;
            const speed=.06+Math.random()*.04;
            c.position.set(dir*-80,0,lane);
            c.rotation.y=dir>0?Math.PI/2:-Math.PI/2;
            scene.add(c);
            trafficCars.push({mesh:c,axis:'x',speed:speed*dir,life:0,maxLife:160/speed});
        }

        // === STATIC GLB CARS (parked around zone) ===
        const CAR_SCALE=.08;
        const carFiles=['car.glb','car2.glb','car3.glb','car4.glb'];
        // 4 inside zone, avoid streets
        function onStreet(x,z){for(let i=-2;i<=2;i++){if(Math.abs(z-i*16)<3.5)return true;if(Math.abs(x-i*16)<3.5)return true}return false}
        const innerSpots=[];
        while(innerSpots.length<4){const x=(Math.random()-.5)*80,z=(Math.random()-.5)*80;if(!onStreet(x,z)&&Math.abs(x)<42&&Math.abs(z)<42)innerSpots.push({x,z,ry:Math.random()*Math.PI*2})}
        // 12 outside zone
        const outerSpots=[];
        for(let i=0;i<12;i++){const a=Math.random()*Math.PI*2,d=52+Math.random()*50;outerSpots.push({x:Math.cos(a)*d,z:Math.sin(a)*d,ry:Math.random()*Math.PI*2})}
        const allSpots=[...innerSpots,...outerSpots];
        carFiles.forEach((name,idx)=>{
            loader.load(GLB_BASE+name,g=>{
                allSpots.filter((_,i)=>i%4===idx).forEach(p=>{
                    const car=g.scene.clone();car.position.set(p.x,0,p.z);car.rotation.y=p.ry;
                    car.scale.set(CAR_SCALE,CAR_SCALE,CAR_SCALE);
                    car.traverse(c=>{if(c.isMesh){c.castShadow=true;c.receiveShadow=true}});
                    scene.add(car)});
            },undefined,()=>{
                // Fallback box car
                allSpots.filter((_,i)=>i%4===idx).forEach(p=>{
                    const c=new THREE.Group();const cm=trafficMat[idx%trafficMat.length];
                    c.add(M(new THREE.BoxGeometry(1.8,.7,4),cm,0,.4,0,true));
                    c.add(M(new THREE.BoxGeometry(1.5,.55,1.8),cm,0,1,-.3));
                    c.position.set(p.x,0,p.z);c.rotation.y=p.ry;scene.add(c)})});
        });

        // === BOUNDARY (invisible) ===
        function M(geo,mat,x,y,z,shadow){const m=new THREE.Mesh(geo,mat);m.position.set(x,y,z);if(shadow)m.castShadow=true;return m}

        // === LIGHTS ===
        const ambient=new THREE.AmbientLight(0xffeedd,.35);scene.add(ambient);
        const sun=new THREE.DirectionalLight(0xffd080,.8);sun.position.set(15,35,15);sun.castShadow=true;
        sun.shadow.mapSize.set(2048,2048);sun.shadow.camera.left=-50;sun.shadow.camera.right=50;
        sun.shadow.camera.top=50;sun.shadow.camera.bottom=-50;scene.add(sun);
        const moon=new THREE.DirectionalLight(0x8888cc,.25);moon.position.set(-20,40,-20);scene.add(moon);
        // Only 4 accent lights total
        const sl=new THREE.SpotLight(0x8B0000,.5);sl.position.set(-25,20,-25);sl.angle=Math.PI/5;sl.penumbra=.7;scene.add(sl);
        const sl2=new THREE.SpotLight(0xD4AF37,.4);sl2.position.set(25,20,25);sl2.angle=Math.PI/5;sl2.penumbra=.7;scene.add(sl2);

        // === GROUND (1024 texture) ===
        const gc=document.createElement('canvas');gc.width=1024;gc.height=1024;const gx=gc.getContext('2d');
        gx.fillStyle='#1c1c1c';gx.fillRect(0,0,1024,1024);
        for(let i=0;i<50;i++){const cx=Math.random()*1024,cy=Math.random()*1024,cr=Math.random()*80+20;
            const gr=gx.createRadialGradient(cx,cy,0,cx,cy,cr);const b=~~(Math.random()*15)+18;
            gr.addColorStop(0,`rgba(${b+8},${b+6},${b+3},.35)`);gr.addColorStop(1,'transparent');gx.fillStyle=gr;gx.fillRect(cx-cr,cy-cr,cr*2,cr*2)}
        for(let i=0;i<15000;i++){const b=~~(Math.random()*30)+12;gx.fillStyle=`rgba(${b},${b},${b},${Math.random()*.3})`;gx.fillRect(Math.random()*1024,Math.random()*1024,Math.random()*2+.5,Math.random()*2+.5)}
        gx.strokeStyle='rgba(8,8,8,.5)';gx.lineWidth=1;
        for(let i=0;i<25;i++){gx.beginPath();let cx=Math.random()*1024,cy=Math.random()*1024;gx.moveTo(cx,cy);for(let j=0;j<4;j++){cx+=(Math.random()-.5)*50;cy+=(Math.random()-.5)*50;gx.lineTo(cx,cy)}gx.stroke()}
        for(let i=0;i<15;i++){gx.fillStyle=`rgba(8,6,4,${Math.random()*.2+.05})`;gx.beginPath();gx.ellipse(Math.random()*1024,Math.random()*1024,Math.random()*20+5,Math.random()*15+5,Math.random()*Math.PI,0,Math.PI*2);gx.fill()}
        const gt=new THREE.CanvasTexture(gc);gt.wrapS=gt.wrapT=THREE.RepeatWrapping;gt.repeat.set(4,4);
        const ground=new THREE.Mesh(new THREE.PlaneGeometry(100,100),new THREE.MeshStandardMaterial({map:gt,roughness:.95,metalness:.05}));
        ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;ground.name='g';scene.add(ground);

        // === STREETS ===
        const sc=document.createElement('canvas');sc.width=256;sc.height=256;const sx=sc.getContext('2d');
        sx.fillStyle='#0f0f0f';sx.fillRect(0,0,256,256);
        for(let i=0;i<4000;i++){const b=~~(Math.random()*22)+6;sx.fillStyle=`rgba(${b},${b},${b},${Math.random()*.5})`;sx.fillRect(Math.random()*256,Math.random()*256,Math.random()*2,Math.random()*2)}
        sx.fillStyle='#FFD700';for(let i=0;i<256;i+=32){sx.fillRect(118,i,10,18);sx.fillRect(128,i,10,18)}
        sx.fillStyle='#FFF';sx.globalAlpha=.6;sx.fillRect(8,0,3,256);sx.fillRect(245,0,3,256);sx.globalAlpha=1;
        const st=new THREE.CanvasTexture(sc);st.wrapS=st.wrapT=THREE.RepeatWrapping;st.repeat.set(1,7);
        const sm=new THREE.MeshStandardMaterial({map:st,roughness:.85});
        for(let i=-2;i<=2;i++){const s=new THREE.Mesh(new THREE.PlaneGeometry(100,5),sm);s.rotation.x=-Math.PI/2;s.position.set(0,.02,i*16);s.receiveShadow=true;s.name='g';scene.add(s)}
        for(let i=-2;i<=2;i++){const s=new THREE.Mesh(new THREE.PlaneGeometry(5,100),sm);s.rotation.x=-Math.PI/2;s.rotation.z=Math.PI/2;s.position.set(i*16,.02,0);s.receiveShadow=true;s.name='g';scene.add(s)}

        // === LAMP POSTS (visual only, NO extra lights ‚Äî using emissive heads) ===
        const lpM=new THREE.MeshStandardMaterial({color:0x222,metalness:.9,roughness:.1});
        const lhM=new THREE.MeshStandardMaterial({color:0xffd700,emissive:0xffd700,emissiveIntensity:6});
        // Only add 2 actual PointLights for key areas, rest are emissive-only
        let lightCount=0;
        for(let x=-40;x<=40;x+=16)for(let z=-40;z<=40;z+=16){
            if(Math.random()>.4){
                const lx=x+(Math.random()-.5)*4,lz=z+(Math.random()-.5)*4;
                const p=new THREE.Mesh(new THREE.CylinderGeometry(.08,.14,9,6),lpM);p.position.set(lx,4.5,lz);p.castShadow=true;scene.add(p);
                const arm=new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,1.5,4),lpM);arm.rotation.z=Math.PI/2;arm.position.set(lx+.6,8.8,lz);scene.add(arm);
                const h=new THREE.Mesh(new THREE.SphereGeometry(.3,8,8),lhM);h.position.set(lx+1.2,8.8,lz);scene.add(h);
                // Only first 4 lamps get real lights
                if(lightCount<6){const lt=new THREE.PointLight(0xffd080,1,25,2);lt.position.set(lx+1.2,8.5,lz);scene.add(lt);lightCount++}
            }}

        // === DECOR ===
        const wM=new THREE.MeshStandardMaterial({color:0x3a2010,roughness:.9});
        const mM=new THREE.MeshStandardMaterial({color:0x333,metalness:.7,roughness:.3});
        for(let i=0;i<8;i++){const b=new THREE.Group();b.add(new THREE.Mesh(new THREE.BoxGeometry(2,.12,.5),wM));
            const bk=new THREE.Mesh(new THREE.BoxGeometry(2,.6,.08),wM);bk.position.set(0,.36,-.22);b.add(bk);
            b.position.set((Math.random()-.5)*75,.25,(Math.random()-.5)*75);b.rotation.y=Math.random()*Math.PI;scene.add(b)}
        for(let i=0;i<10;i++){const t=new THREE.Mesh(new THREE.CylinderGeometry(.25,.3,.7,8),mM);t.position.set((Math.random()-.5)*75,.35,(Math.random()-.5)*75);scene.add(t)}

        // === PLAYER ===
        player=new THREE.Group();const bM=new THREE.MeshStandardMaterial({color:0x111,roughness:.5,metalness:.1});
        player.add(M(new THREE.CylinderGeometry(.36,.46,1.15,8),bM,0,.58,0,true));
        player.add(M(new THREE.BoxGeometry(1,.18,.45),bM,0,1.1,0));
        player.add(M(new THREE.SphereGeometry(.27,16,16),new THREE.MeshStandardMaterial({color:0xFFDBB5,roughness:.8}),0,1.45,0));
        player.add(M(new THREE.CylinderGeometry(.42,.42,.04,16),new THREE.MeshStandardMaterial({color:0x111}),0,1.63,0));
        player.add(M(new THREE.CylinderGeometry(.2,.26,.3,16),new THREE.MeshStandardMaterial({color:0x111}),0,1.82,0));
        player.add(M(new THREE.CylinderGeometry(.265,.265,.05,16),new THREE.MeshStandardMaterial({color:0xD4AF37,metalness:.8,roughness:.2}),0,1.69,0));
        player.add(M(new THREE.BoxGeometry(.09,.45,.04),new THREE.MeshStandardMaterial({color:0xD4AF37,emissive:0xD4AF37,emissiveIntensity:.3,metalness:.8}),0,.78,.4));
        const lM=new THREE.MeshStandardMaterial({color:0x111});
        [-.14,.14].forEach(x=>{player.add(M(new THREE.CylinderGeometry(.13,.13,.75,8),lM,x,.38,0))});
        const sM=new THREE.MeshStandardMaterial({color:0x080808,metalness:.7,roughness:.3});
        [-.14,.14].forEach(x=>{player.add(M(new THREE.BoxGeometry(.18,.09,.28),sM,x,0,.04))});
        // === TOMMY GUN ===
        const gunMat=new THREE.MeshStandardMaterial({color:0x222,metalness:.8,roughness:.2});
        const woodMat2=new THREE.MeshStandardMaterial({color:0x3a1a08,roughness:.8,metalness:.05});
        const gunGroup=new THREE.Group();
        // Barrel
        gunGroup.add(M(new THREE.CylinderGeometry(.03,.03,.9,8),gunMat,0,0,.45));
        gunGroup.children[0].rotation.x=Math.PI/2;
        // Body
        gunGroup.add(M(new THREE.BoxGeometry(.12,.1,.5),gunMat,0,0,.1));
        // Drum magazine
        gunGroup.add(M(new THREE.CylinderGeometry(.1,.1,.12,12),gunMat,0,-.08,.05));
        // Stock
        gunGroup.add(M(new THREE.BoxGeometry(.08,.08,.35),woodMat2,0,.01,-.25));
        // Grip
        gunGroup.add(M(new THREE.BoxGeometry(.06,.12,.04),woodMat2,0,-.06,-.05));
        // Muzzle flash point (for future use)
        const muzzle=new THREE.Mesh(new THREE.SphereGeometry(.02,4,4),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:0}));
        muzzle.position.set(0,0,.9);gunGroup.add(muzzle);
        gunGroup.position.set(.45,.85,.15);
        gunGroup.rotation.set(0,0,-.15);
        player.add(gunGroup);
        scene.add(player);
        const mk=new THREE.Mesh(new THREE.RingGeometry(.65,.95,32),new THREE.MeshBasicMaterial({color:0xD4AF37,side:THREE.DoubleSide,transparent:true,opacity:.6}));
        mk.rotation.x=-Math.PI/2;mk.position.y=.05;scene.add(mk);player.mk=mk;
        const gl=new THREE.Mesh(new THREE.CircleGeometry(1,32),new THREE.MeshBasicMaterial({color:0xD4AF37,transparent:true,opacity:.12,side:THREE.DoubleSide}));
        gl.rotation.x=-Math.PI/2;gl.position.y=.03;scene.add(gl);player.gl=gl;

        // === CONTROLS ===
        const PLIM=44;
        const ray=new THREE.Raycaster(),mo=new THREE.Vector2();
        function gp(e){mo.x=(e.clientX/innerWidth)*2-1;mo.y=-(e.clientY/innerHeight)*2+1;ray.setFromCamera(mo,camera);
            const h=ray.intersectObjects(scene.children.filter(o=>o.name==='g'));return h.length?h[0].point:null}
        cv.addEventListener('click',e=>{if(!gameActive)return;const pt=gp(e);if(!pt)return;
            const cx=Math.max(-PLIM,Math.min(PLIM,pt.x)),cz=Math.max(-PLIM,Math.min(PLIM,pt.z));
            if(placing){placeCasino({x:cx,z:cz})}else{target={x:cx,z:cz};moving=true;makeWP({x:cx,y:.1,z:cz})}});
        cv.addEventListener('contextmenu',e=>{e.preventDefault();if(placing)exitPlacement()});
        cv.addEventListener('mousemove',e=>{if(!placing||!placeGlow)return;const pt=gp(e);if(!pt)return;
            placeGlow.position.set(pt.x,.1,pt.z);placeInner.position.set(pt.x,.08,pt.z);
            placeArrows.forEach(a=>{a.position.set(pt.x+a.userData.ox,.12,pt.z+a.userData.oz);a.rotation.z=a.userData.rz})});
        cv.addEventListener('wheel',e=>{e.preventDefault();camDist+=e.deltaY*.03;camDist=Math.max(camMin,Math.min(camMax,camDist))},{passive:false});

        // === ANIMATE ===
        (function run(){if(!gameActive)return;requestAnimationFrame(run);const t=Date.now()*.001;
            // Day/night cycle
            const sunY=Math.sin(t*.05);
            skyMat.uniforms.uTime.value=t;
            const dayF=Math.max(0,Math.min(1,(sunY+.2)/.5));
            ambient.intensity=.3+dayF*.25;
            sun.intensity=.4+dayF*.5;
            moon.intensity=.15+(.4-dayF*.3);
            sun.position.set(Math.cos(t*.05)*40,15+sunY*25,Math.sin(t*.05)*40);
            const fogC=new THREE.Color().lerpColors(new THREE.Color(0x0a0a12),new THREE.Color(0x1a1815),dayF);
            scene.fog.color.copy(fogC);

            if(moving&&target){const dx=target.x-player.position.x,dz=target.z-player.position.z,d=Math.sqrt(dx*dx+dz*dz);
                if(d>.5){player.position.x+=(dx/d)*.22;player.position.z+=(dz/d)*.22;
                    // Clamp to bounds
                    player.position.x=Math.max(-PLIM,Math.min(PLIM,player.position.x));
                    player.position.z=Math.max(-PLIM,Math.min(PLIM,player.position.z));
                    player.mk.position.set(player.position.x,.05,player.position.z);
                    player.gl.position.set(player.position.x,.03,player.position.z);
                    player.rotation.y=Math.atan2(dx,dz);player.position.y=Math.sin(t*8)*.08;
                }else{moving=false;player.position.y=0;removeWP()}}
            if(player.mk)player.mk.material.opacity=.35+Math.sin(t*3)*.2;
            camera.position.x+=(player.position.x-camera.position.x)*.05;
            camera.position.z+=(player.position.z+camDist*.7-camera.position.z)*.05;
            camera.position.y+=(camDist-camera.position.y)*.05;
            camera.lookAt(player.position.x,0,player.position.z);
            if(placing&&placeGlow&&placeGlow.visible){
                placeGlow.material.opacity=.3+Math.sin(t*4)*.2;placeInner.material.opacity=.1+Math.sin(t*3)*.06;
                const s=1+Math.sin(t*2)*.05;placeGlow.scale.set(s,s,s);
                placeArrows.forEach((a,i)=>{a.material.opacity=.5+Math.sin(t*4+i)*.3})}
            if(wp){wp.material.opacity=.5+Math.sin(t*5)*.3;wpArr.forEach((a,i)=>{a.material.opacity=.4+Math.sin(t*5+i*.5)*.3})}
            // Traffic cars
            for(let i=trafficCars.length-1;i>=0;i--){
                const tc=trafficCars[i];tc.mesh.position[tc.axis]+=tc.speed;tc.life++;
                if(tc.life>tc.maxLife){scene.remove(tc.mesh);trafficCars.splice(i,1)}
            }
            // Spawn new cars occasionally
            if(Math.random()<.0005&&trafficCars.length<1) spawnTrafficCar();
            // Minimap
            const mc=document.getElementById('mm');if(mc){const ctx=mc.getContext('2d'),sz=200,ms=100;
                ctx.fillStyle='#080808';ctx.fillRect(0,0,sz,sz);
                ctx.strokeStyle='rgba(212,175,55,.06)';ctx.lineWidth=1;
                for(let i=0;i<=10;i++){const v=i/10*sz;ctx.beginPath();ctx.moveTo(v,0);ctx.lineTo(v,sz);ctx.stroke();ctx.beginPath();ctx.moveTo(0,v);ctx.lineTo(sz,v);ctx.stroke()}
                ctx.strokeStyle='rgba(80,80,80,.25)';ctx.lineWidth=2;
                for(let i=-2;i<=2;i++){const y=((i*16+ms/2)/ms)*sz;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(sz,y);ctx.stroke();
                    const x=((i*16+ms/2)/ms)*sz;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,sz);ctx.stroke()}
                casinos.forEach(c=>{const mx=((c.pos.x+ms/2)/ms)*sz,my=((c.pos.z+ms/2)/ms)*sz;
                    const gr=ctx.createRadialGradient(mx,my,0,mx,my,10);gr.addColorStop(0,'rgba(212,175,55,.35)');gr.addColorStop(1,'transparent');
                    ctx.fillStyle=gr;ctx.fillRect(mx-10,my-10,20,20);ctx.fillStyle='#D4AF37';ctx.fillRect(mx-3,my-3,6,6);
                    ctx.strokeStyle='#D4AF37';ctx.lineWidth=1;ctx.strokeRect(mx-4,my-4,8,8)});
                const px=((player.position.x+ms/2)/ms)*sz,py=((player.position.z+ms/2)/ms)*sz;
                ctx.fillStyle='#D4AF37';ctx.beginPath();ctx.arc(px,py,4,0,Math.PI*2);ctx.fill();
                ctx.strokeStyle='#F5E6D3';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(px,py,6,0,Math.PI*2);ctx.stroke();
                ctx.strokeStyle='rgba(212,175,55,.5)';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(px,py);
                ctx.lineTo(px+Math.sin(player.rotation.y)*10,py+Math.cos(player.rotation.y)*10);ctx.stroke();
                ctx.strokeStyle='#D4AF37';ctx.lineWidth=2;ctx.strokeRect(0,0,sz,sz)}
            renderer.render(scene,camera)})();

        window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
        setInterval(()=>{if(gameActive&&casinos.length>0){money+=(casinos.length*INCOME)/3600;updateUI()}},1000);
    });
    </script>
</body>
</html>
